version: "3.9"

configs:
  init_kernels:
    file: ./init-kernels.sh
  entrypoint:
    file: ./entrypoint.sh

services:
  jupyter_ogiovanni:
    image: jupyter/datascience-notebook:python-3.11
    healthcheck:
      disable: true
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - NVIDIA_VISIBLE_DEVICES=0
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - CUDA_VISIBLE_DEVICES=0
      - CHOWN_HOME=yes
      - CHOWN_HOME_OPTS='-R'
    volumes:
      - /srv/fastdata/jupyter/ogiovanni:/home/jovyan/work
      - /srv/fastdata/jupyter/ogiovanni/.local:/home/jovyan/.local
      - /srv/fastdata/jupyter/ogiovanni/.venv:/home/jovyan/.venv
    configs:
      - source: init_kernels
        target: /tmp/init-kernels.sh
        mode: 0755
      - source: entrypoint
        target: /tmp/entrypoint.sh
        mode: 0755
    networks:
      - public
      - internal
    command: >
      bash -c "/tmp/entrypoint.sh
      --ServerApp.ip=0.0.0.0
      --ServerApp.port=8888
      --ServerApp.token=''
      --ServerApp.password=''
      --ServerApp.allow_remote_access=True"
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == master2
          - node.labels.tier == compute
      resources:
        limits:
          cpus: '8.0'
          memory: 12G
        reservations:
          cpus: '4.0'
          memory: 8G
      restart_policy:
        condition: any
        delay: 10s
        max_attempts: 3
        window: 60s
      labels:
        - traefik.enable=true
        - traefik.docker.network=public
        - traefik.http.routers.jupyter-ogiovanni.rule=Host(`jupyter-ogiovanni.sexydad`)
        - traefik.http.routers.jupyter-ogiovanni.entrypoints=websecure
        - traefik.http.routers.jupyter-ogiovanni.tls=true
        - traefik.http.routers.jupyter-ogiovanni.middlewares=jupyter-chain@docker
        - traefik.http.services.jupyter-ogiovanni.loadbalancer.server.port=8888

  jupyter_odavid:
    image: jupyter/datascience-notebook:python-3.11
    healthcheck:
      disable: true
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - NVIDIA_VISIBLE_DEVICES=0
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - CUDA_VISIBLE_DEVICES=0
      - CHOWN_HOME=yes
      - CHOWN_HOME_OPTS='-R'
    volumes:
      - /srv/fastdata/jupyter/odavid:/home/jovyan/work
      - /srv/fastdata/jupyter/odavid/.local:/home/jovyan/.local
      - /srv/fastdata/jupyter/odavid/.venv:/home/jovyan/.venv
    configs:
      - source: init_kernels
        target: /tmp/init-kernels.sh
        mode: 0755
      - source: entrypoint
        target: /tmp/entrypoint.sh
        mode: 0755
    networks:
      - public
      - internal
    command: >
      bash -c "/tmp/entrypoint.sh
      --ServerApp.ip=0.0.0.0
      --ServerApp.port=8888
      --ServerApp.token=''
      --ServerApp.password=''
      --ServerApp.allow_remote_access=True"
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == master2
          - node.labels.tier == compute
      resources:
        limits:
          cpus: '8.0'
          memory: 12G
        reservations:
          cpus: '4.0'
          memory: 8G
      restart_policy:
        condition: any
        delay: 10s
        max_attempts: 3
        window: 60s
      labels:
        - traefik.enable=true
        - traefik.docker.network=public
        - traefik.http.routers.jupyter-odavid.rule=Host(`jupyter-odavid.sexydad`)
        - traefik.http.routers.jupyter-odavid.entrypoints=websecure
        - traefik.http.routers.jupyter-odavid.tls=true
        - traefik.http.routers.jupyter-odavid.middlewares=jupyter-chain@docker
        - traefik.http.services.jupyter-odavid.loadbalancer.server.port=8888

networks:
  public:
    external: true
  internal:
    external: true